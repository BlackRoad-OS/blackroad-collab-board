name: Cross-Repo Cohesion Analysis

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated list of repos to analyze (leave empty for all)'
        required: false
        type: string
      deep:
        description: 'Run deep analysis'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  analyze-cohesion:
    name: Analyze Suite Cohesion
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Trigger Full Repo Sync
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.WORKER_API_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.WORKER_URL }}/sync/repos"

      - name: Wait for sync
        run: sleep 60

      - name: Run Cohesion Analysis
        id: cohesion
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.WORKER_API_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.WORKER_URL }}/sync/cohesion/check")

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

          # Extract score
          SCORE=$(echo $RESPONSE | jq -r '.report.overallScore // 0')
          echo "score=$SCORE" >> $GITHUB_OUTPUT

          # Extract issue count
          ISSUES=$(echo $RESPONSE | jq -r '.report.issues | length // 0')
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

      - name: Get Detailed Report
        run: |
          curl -s \
            -H "Authorization: Bearer ${{ secrets.WORKER_API_KEY }}" \
            "${{ secrets.WORKER_URL }}/sync/cohesion/report" | jq .

      - name: Check Cohesion Score
        run: |
          SCORE=${{ steps.cohesion.outputs.score }}
          ISSUES=${{ steps.cohesion.outputs.issues }}

          echo "Cohesion Score: $SCORE"
          echo "Issues Found: $ISSUES"

          if [ "$SCORE" -lt 70 ]; then
            echo "::warning::Cohesion score is below threshold (70): $SCORE"
          fi

          if [ "$ISSUES" -gt 5 ]; then
            echo "::warning::High number of cohesion issues: $ISSUES"
          fi

      - name: Create Issue for Critical Problems
        if: steps.cohesion.outputs.score < 50
        uses: actions/github-script@v7
        with:
          script: |
            const score = ${{ steps.cohesion.outputs.score }};
            const issues = ${{ steps.cohesion.outputs.issues }};

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Auto] Critical Cohesion Alert - Score: ${score}`,
              body: `## Cohesion Analysis Alert

              The automated cohesion analysis has detected critical issues:

              - **Score**: ${score}/100
              - **Issues**: ${issues}

              Please review the cohesion report and address any critical issues.

              This issue was automatically created by the cohesion analysis workflow.

              ---
              â¬›â¬œðŸ›£ï¸ BlackRoad Collab Board`,
              labels: ['automated', 'cohesion', 'critical']
            });

  sync-monitored-repos:
    name: Sync All Monitored Repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - BlackRoad-OS/blackroad-prism-console
          - BlackRoad-OS/blackroad-collab-board
          - BlackRoad-OS/blackroad-agent-sdk
          - BlackRoad-OS/blackroad-core
    steps:
      - name: Sync ${{ matrix.repo }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.WORKER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"repo": "${{ matrix.repo }}"}' \
            "${{ secrets.WORKER_URL }}/sync/queue"
        continue-on-error: true

  report-summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [analyze-cohesion, sync-monitored-repos]
    steps:
      - name: Get Final Report
        run: |
          echo "## BlackRoad Suite Cohesion Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated at: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get the report
          REPORT=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.WORKER_API_KEY }}" \
            "${{ secrets.WORKER_URL }}/sync/cohesion/report")

          SCORE=$(echo $REPORT | jq -r '.report.overallScore // "N/A"')
          REPOS=$(echo $REPORT | jq -r '.report.repos | length // 0')
          ISSUES=$(echo $REPORT | jq -r '.report.issues | length // 0')

          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Cohesion Score**: $SCORE/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Repos Analyzed**: $REPOS" >> $GITHUB_STEP_SUMMARY
          echo "- **Issues Found**: $ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$ISSUES" -gt 0 ]; then
            echo "### Issues" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo $REPORT | jq '.report.issues' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo $REPORT | jq -r '.report.recommendations[]? // "No recommendations"' | while read rec; do
            echo "- $rec" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "â¬›â¬œðŸ›£ï¸ *Generated by BlackRoad Collab Board*" >> $GITHUB_STEP_SUMMARY
